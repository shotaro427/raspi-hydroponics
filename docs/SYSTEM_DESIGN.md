# Raspberry Pi 水耕栽培自動化システム

> **Project**: raspi-hydroponics
> **Status**: 構想段階
> **Last Updated**: 2026-02-05

## 1. プロジェクト概要

家庭で育てているハーブの水耕栽培を、Raspberry Pi 4 Model B 1台で自動化する。
水やり・水の循環・藻の繁殖防止を主な目的とし、センサーデータの可視化も行う。

### 目標
- 水の循環を自動制御（タイマー + センサーベース）
- 藻の繁殖を複合的に防止（遮光 + UV + 水温管理）
- pH・EC・水温をモニタリングし、異常時にアラート
- Grafanaダッシュボードでスマホから状態を確認

---

## 2. システム構成図

```
  ┌──────────────────────────────────────────────────────────┐
  │  Raspberry Pi 4 Model B (4GB)  ── 1台で制御+サーバー兼務  │
  │                                                          │
  │  ┌─────────────────┐    ┌──────────────────────────┐     │
  │  │ Python 制御      │    │ Docker Compose           │     │
  │  │ デーモン         │    │                          │     │
  │  │                 │    │  Mosquitto (MQTT)        │     │
  │  │ - センサー読取   │───►│  InfluxDB (時系列DB)      │     │
  │  │ - ポンプ制御    │    │  Grafana (可視化)         │     │
  │  │ - 緊急停止      │    │                          │     │
  │  │ - MQTT送信      │    │  localhost:1883 (MQTT)   │     │
  │  │   (localhost)   │    │  localhost:3000 (Grafana) │     │
  │  └─────────────────┘    └──────────────────────────┘     │
  │                                                          │
  │  GPIO接続:                    Wi-Fi:                      │
  │  ┌─────────┐                  http://<ip>:3000            │
  │  │センサー群│                  スマホからアクセス可能        │
  │  │pH/EC/水温│                                             │
  │  │水位/気温 │                                             │
  │  └─────────┘                                             │
  │  ┌─────────┐                                             │
  │  │アクチュエータ│                                         │
  │  │ポンプ/UV/   │                                         │
  │  │リレー       │                                         │
  │  └─────────┘                                             │
  └──────────────────────────────────────────────────────────┘


  ─── 物理構成（栽培エリア）───

  ┌─────────────────────────────────────────────────────┐
  │                   NFT チャンネル                      │
  │   ┌───┐  ┌───┐  ┌───┐  ┌───┐  ┌───┐  ┌───┐        │
  │   │バジ│  │ミン│  │パセ│  │シソ│  │   │  │   │        │
  │   │ル │  │ト │  │リ │  │  │  │   │  │   │        │
  │   └─┬─┘  └─┬─┘  └─┬─┘  └─┬─┘  └─┬─┘  └─┬─┘        │
  │     └──────┴──────┴──────┴──────┴──────┘            │
  │              薄い養液の膜が流れる                       │
  │     ─────────────────────────────►  傾斜              │
  └───────────────────────────┬─────────────────────────┘
                              │ 戻り
  ┌───────────────────────────┴─────────────────────────┐
  │              リザーバー（不透明・遮光）                  │
  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
  │  │循環ポンプ │  │エアポンプ │  │UV殺菌灯  │           │
  │  │(DC12V)   │  │(酸素供給) │  │(インライン)│           │
  │  └──────────┘  └──────────┘  └──────────┘           │
  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │
  │  │pHセンサー │  │ECセンサー │  │水温センサー│           │
  │  │          │  │          │  │(DS18B20)  │           │
  │  └──────────┘  └──────────┘  └──────────┘           │
  │  ┌──────────────────────┐                            │
  │  │フロートスイッチ(水位) │                            │
  │  └──────────────────────┘                            │
  └─────────────────────────────────────────────────────┘
         ▲                    ▲
         │ 給液               │ pH調整液
  ┌──────┴──────┐    ┌───────┴───────┐
  │ペリスタル    │    │ペリスタル      │
  │ティックポンプ │    │ティックポンプ   │
  │(栄養素A/B)  │    │(pH up/down)   │
  └─────────────┘    └───────────────┘
```

---

## 4. 水耕方式の選定

ハーブ栽培には **NFT（薄膜水耕法）** を推奨。

| 方式 | 仕組み | ハーブ適性 | 藻リスク | 複雑さ |
|------|--------|-----------|---------|-------|
| **NFT** | 薄い養液膜がチャンネルを流れる | バジル・ミント・パセリに最適 | 中（チャンネル内に光が入りうる） | 中 |
| DWC | 根を養液に常時浸漬 | バジルには良いが、ローズマリー・タイム等は不適（過湿） | 高（水面面積が大きい） | 低 |
| Ebb&Flow | 定期的に浸水→排水 | 全般的に良い | 低（水が溜まる時間が短い） | 高 |
| Kratky | パッシブ（ポンプ不要） | 小規模なら可 | 低 | 最低 |

**NFTを選ぶ理由**:
- バジル・ミント等の高速成長ハーブに最適
- 水の循環が常時あるため自動化と相性が良い
- 根の上部が空気に触れるので酸素供給が良好
- チャンネルの遮光をしっかりすれば藻のリスクも管理可能

---

## 5. 藻の繁殖防止戦略（多層防御）

藻は「光 + 栄養素 + 適温の水」で繁殖する。栄養素は除去できないため、光と温度を制御する。

### Layer 1: 遮光（最重要・最優先）
- **不透明リザーバー**: 黒色のHDPE容器またはアルミホイルで遮光
- **チャンネルカバー**: ネットポットの隙間をネオプレンディスクで塞ぐ
- **配管の遮光**: 全て黒色・不透明チューブを使用（透明チューブ厳禁）
- コスト: ほぼゼロ（材料選定の問題）

### Layer 2: 水温管理（18-22度C維持）
- DS18B20センサーで常時モニタリング
- 夏場: 水槽用チラーまたはペルチェ素子で冷却
  - ペルチェ素子は小規模（5L以下）なら有効。大規模リザーバーには力不足
  - 50Wペルチェで12ガロン(約45L)を5.5度C冷やすのに約7.8時間かかる
- 冬場: 水槽用ヒーターで加温
- RPiでPID制御して目標温度を維持

### Layer 3: UV-C殺菌（インライン方式）
- 循環配管にインラインUVステライザーを設置
- 養液が通過する際にUV-C光で藻の胞子を不活性化
- 化学物質不使用で植物に安全
- 注意: 配管内壁に付着した藻には効果なし（浮遊する単細胞藻にのみ有効）
- 製品例: アクアリウム用インラインUVステライザー（15-25W、3,000-8,000円）

### Layer 4: 過酸化水素（H2O2）自動投与（オプション）
- 3%過酸化水素を約0.8ml/L の割合で投与
- 週1回の定期投与をペリスタルティックポンプで自動化
- 藻を殺しつつ根にも酸素を供給する副次効果
- 過剰投与は植物を傷めるので注意

### Layer 5: 水流管理
- 停滞水は藻の温床。常に循環を維持
- NFT方式なら常時ポンプが動いているため有利

---

## 6. ハードウェア構成

> 全材料の一覧・価格は [docs/BOM.md](./BOM.md) を参照

### Pi 4 Model B: 制御 + サーバー（1台構成）

**役割**: センサー読取 + アクチュエーター制御 + データ収集 + 可視化

#### ボード

| カテゴリ | 部品 | 型番 | 備考 |
|---------|------|------|------|
| ボード | Raspberry Pi 4 Model B (4GB) | - | 手持ち |
| OS | Raspberry Pi OS (64bit) | - | OSインストール・WiFi設定済み |

#### センサー・アクチュエーター（GPIO接続）

| カテゴリ | 部品 | 型番 | 接続 | 概算価格 |
|---------|------|------|------|---------|
| pH | pHセンサー | DFRobot SEN0161-V2 (入門) or Atlas EZO-pH (高精度) | アナログ→ADC→I2C | 2,000円 / 15,000円 |
| EC/TDS | ECセンサー | DFRobot SEN0244 (入門) or Atlas EZO-EC (高精度) | アナログ→ADC→I2C | 1,500円 / 15,000円 |
| 水温 | 防水温度センサー | DS18B20（防水型） | 1-Wire (GPIO4) | 500円 |
| 水位 | フロートスイッチ | PP製フロートスイッチ | GPIO | 300円 |
| 気温・湿度 | 温湿度センサー | DHT22 or BME280 | GPIO / I2C | 500-1,500円 |
| ADC | アナログ-デジタル変換 | ADS1115 (16bit) | I2C | 500円 |
| リレー | ポンプ制御 | 4chリレーモジュール | GPIO | 500円 |
| 循環ポンプ | 養液循環 | DC12V水中ポンプ | リレー経由 | 1,500円 |
| エアポンプ | 酸素供給 | アクアリウム用 | リレー経由 | 1,500円 |
| ペリスタルティック | pH調整液投与 | DC12Vペリスタルティック x2 | L293Dモータードライバー | 3,000円x2 |
| UV殺菌 | 藻対策 | インラインUVステライザー | リレー経由 | 5,000円 |
| 電源 | 12V電源 | AC-DC 12V 5A | - | 1,500円 |

**注意**: pH と EC センサーを同時使用する場合、**電気的絶縁が必須**。ECセンサーが放出する微弱電流がpH測定に干渉する。Atlas Scientific の絶縁USBキャリアボードか、センサー読取のタイミングをずらす（EC測定時にpHセンサーの電源を切る）方法で対処。

#### ソフトウェア（Docker Compose・同一マシン上）

| カテゴリ | ソフト | 備考 |
|---------|--------|------|
| MQTT | Mosquitto | ブローカー (localhost:1883) |
| DB | InfluxDB 2.x | 時系列データ保存 |
| 可視化 | Grafana | ダッシュボード (localhost:3000) |
| コンテナ | Docker Compose | 全サービスをコンテナ化 |

将来、栽培エリアの拡張や負荷分散が必要になった場合は、MQTT通信で制御ノードとサーバーノードを2台に分離できる。現時点では1台で十分。

---

## 7. ソフトウェアアーキテクチャ

### 制御デーモン（Python）

```
raspi-hydroponics/
├── controller/
│   ├── main.py              # メインループ
│   ├── sensors/
│   │   ├── ph.py            # pH読取
│   │   ├── ec.py            # EC/TDS読取
│   │   ├── temperature.py   # 水温・気温読取
│   │   └── water_level.py   # 水位読取
│   ├── actuators/
│   │   ├── pump.py          # 循環ポンプ制御
│   │   ├── dosing.py        # ペリスタルティックポンプ制御
│   │   ├── uv.py            # UV殺菌制御
│   │   └── air_pump.py      # エアポンプ制御
│   ├── mqtt_client.py       # MQTTパブリッシュ/サブスクライブ
│   ├── safety.py            # 緊急停止ロジック
│   └── config.yaml          # 設定ファイル
```

### MQTTトピック設計

```
hydroponics/
├── sensors/
│   ├── ph              # pH値 (float)
│   ├── ec              # EC値 (float, μS/cm)
│   ├── water_temp      # 水温 (float, °C)
│   ├── air_temp        # 気温 (float, °C)
│   ├── humidity        # 湿度 (float, %)
│   └── water_level     # 水位 (bool or float)
├── actuators/
│   ├── pump/status     # 循環ポンプ状態
│   ├── air_pump/status # エアポンプ状態
│   ├── uv/status       # UV殺菌状態
│   └── dosing/status   # 投与ポンプ状態
├── alerts/
│   ├── ph_out_of_range
│   ├── ec_out_of_range
│   ├── temp_out_of_range
│   └── water_level_low
└── commands/
    ├── pump/set        # ポンプ制御コマンド
    ├── dosing/ph_up    # pH上昇コマンド
    └── dosing/ph_down  # pH下降コマンド
```

### Docker Compose構成（同一マシン上）

```yaml
# docker-compose.yml (概要)
services:
  mosquitto:
    image: eclipse-mosquitto
    ports: ["1883:1883"]

  influxdb:
    image: influxdb:2
    ports: ["8086:8086"]
    volumes: ["influxdb-data:/var/lib/influxdb2"]

  grafana:
    image: grafana/grafana
    ports: ["3000:3000"]
    volumes: ["grafana-data:/var/lib/grafana"]
```

---

## 8. データフロー

```
                    ── 全て同一マシン（Pi 4 Model B）内 ──

[センサー] → [Python制御デーモン] → [MQTT Publish (localhost)]
                                           │
                                           ▼
                                   [Mosquitto (localhost)]
                                           │
                                    ┌──────┴──────┐
                                    ▼             ▼
                               [InfluxDB]    [Grafana]
                                                  │
                                                  ▼
                                           ダッシュボード
                                        (スマホでアクセス)
```

### センサー読取間隔

| センサー | 間隔 | 理由 |
|---------|------|------|
| 水温 | 60秒 | 温度変化は緩やか |
| pH | 120秒 | 頻繁に読むとプローブ寿命が縮む |
| EC | 120秒 | pH計測と交互に（電気的干渉回避） |
| 水位 | 30秒 | 水切れは即座に対応が必要 |
| 気温・湿度 | 300秒 | 環境データ。急変しない |

---

## 9. 安全設計

### 緊急停止条件
| 条件 | アクション |
|------|----------|
| 水位が最低レベル以下 | 全ポンプ即停止 + アラート |
| 水温が30度C超 | 循環ポンプのみ維持 + アラート |
| pHが4.0以下 or 8.0以上 | 投与ポンプ停止 + アラート |
| 電流異常（ポンプ過負荷） | 該当ポンプ停止 + アラート |

### フォールバック制御
Docker Composeサービスが停止した場合、制御デーモンはMQTTブローカーに接続できなくてもローカルフォールバックで独立動作する:
- 循環ポンプ: 15分ON / 15分OFFのタイマー制御
- エアポンプ: 常時ON
- UV殺菌: 30分ON / 30分OFF
- 投与ポンプ: 全停止（安全側に倒す）

---

## 10. 実装ロードマップ

### Phase 1: 基盤構築（最小構成で動かす）
- [ ] Docker Compose環境構築（Mosquitto + InfluxDB + Grafana）
- [ ] Python制御デーモンの骨格作成
- [ ] 水温センサー（DS18B20）1つだけ接続してデータがGrafanaに表示されることを確認
- [ ] MQTT通信の疎通確認

### Phase 2: センサー拡張
- [ ] pHセンサー追加（まずはDFRobot安価版で検証）
- [ ] 水位センサー（フロートスイッチ）追加
- [ ] 気温・湿度センサー追加
- [ ] Grafanaダッシュボードにウィジェット追加

### Phase 3: アクチュエーター制御
- [ ] 循環ポンプのリレー制御（タイマー + 水位連動）
- [ ] エアポンプのリレー制御
- [ ] 緊急停止ロジック実装

### Phase 4: 藻対策
- [ ] インラインUVステライザー設置
- [ ] 水温管理（冷却/加温）の実装
- [ ] リザーバー・配管の完全遮光

### Phase 5: 高度な自動化
- [ ] ペリスタルティックポンプでpH自動調整
- [ ] EC値に基づく栄養素自動投与
- [ ] アラート通知（LINE or Discord）※ Node-REDはオプション
- [ ] 長期データ分析・トレンド表示

---

## 11. コスト概算

### 最小構成（Phase 1-2）

| 品目 | 数量 | 単価 | 小計 |
|------|------|------|------|
| Raspberry Pi 4 Model B (手持ち) | 1台 | 0円 | 0円 |
| DS18B20（防水） | 1個 | 500円 | 500円 |
| DHT22 | 1個 | 500円 | 500円 |
| ADS1115 ADC | 1個 | 500円 | 500円 |
| DFRobot pHセンサー | 1個 | 2,000円 | 2,000円 |
| フロートスイッチ | 1個 | 300円 | 300円 |
| ブレッドボード・ジャンパー線 | 一式 | 1,000円 | 1,000円 |
| SDカード（手持ちがなければ） | 1枚 | 1,000円 | 1,000円 |
| **小計** | | | **約5,800円** |

### フル構成（Phase 1-5）

| 品目 | 数量 | 単価 | 小計 |
|------|------|------|------|
| 上記最小構成 | - | - | 5,800円 |
| DFRobot ECセンサー | 1個 | 1,500円 | 1,500円 |
| 4chリレーモジュール | 1個 | 500円 | 500円 |
| DC12V水中ポンプ | 1個 | 1,500円 | 1,500円 |
| エアポンプ | 1個 | 1,500円 | 1,500円 |
| ペリスタルティックポンプ | 2個 | 3,000円 | 6,000円 |
| L293Dモータードライバー | 1個 | 300円 | 300円 |
| インラインUVステライザー | 1個 | 5,000円 | 5,000円 |
| AC-DC 12V 5A電源 | 1個 | 1,500円 | 1,500円 |
| NFTチャンネル・配管材料 | 一式 | 5,000円 | 5,000円 |
| 防水ケース（Pi用） | 1個 | 1,000円 | 1,000円 |
| **合計** | | | **約30,100円** |

---

